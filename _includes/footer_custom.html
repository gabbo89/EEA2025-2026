{%- if site.footer_content -%}
  <p class="text-small text-grey-dk-100 mb-0">{{ site.footer_content }}</p>
{%- endif -%}


{% if page.usetocbot %} 
    <!-- tocbot is an awesome table of contents generator, see: https://tscanlin.github.io/tocbot/ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>

    <script>
      /* Dynamically add the toc navbar after the side-bar element. This allows us
         to *not* have to override default.html in _layouts */
      let sideBarElements = document.getElementsByClassName('side-bar');
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
      let tocNav = document.createElement('nav');
      tocNav.setAttribute("id", "tocbot-toc");
      tocNav.classList.add("js-toc");
      tocNav.classList.add("tocbot-right");
      /* Always append the TOC nav to the document body so a positioned
         ancestor (like the sidebar) won't change how `position: fixed`
         is interpreted by the browser (some transforms make fixed act
         like absolute relative to the ancestor). */
      document.body.appendChild(tocNav);
=======
=======
>>>>>>> parent of 1540564 (tocbot)
=======
>>>>>>> parent of 1540564 (tocbot)
      if (sideBarElements.length > 0){
        let tocNav = document.createElement('nav');
        tocNav.setAttribute("id", "tocbot-toc");
        tocNav.classList.add("js-toc");
        tocNav.classList.add("tocbot-right");
        sideBarElements[0].after(tocNav);
      }
>>>>>>> parent of 1540564 (tocbot)

      /** WARNING: YOU MUST USE C MULTI-LINE COMMENT STYLE RATHER THAN // BECAUSE 
       *  OF HOW JEKYLL COMPILES THIS FILE INTO SINGLE LINES **/
      tocbot.init({
        /* Where to render the table of contents. */
        tocSelector: '.js-toc',
        /* Where to grab the headings to build the table of contents. */
        contentSelector: '.main-content',
        /* How many heading levels should collapse. Default is 0 */
        collapseDepth: 2,
        /* Which headings to grab inside of the contentSelector element. */
        headingSelector: 'h1, h2, h3, h4',
      });

      /* Track scrolling to show/hide the tocbot navigation bar on right side */
      var onScrollHandler = function (event) {

        /* End event listener after visitor scrolls past 500px */
        if (window.pageYOffset > 500) {
          window.removeEventListener('scroll', onScrollHandler, false);
          document.getElementById("tocbot-toc").style.visibility = "visible";
        }
        /* console.log("window scroll event:", window.pageYOffset); */
      };

      /* Listen for scroll events */
      window.addEventListener('scroll', onScrollHandler, false);

      /*
       * Position the TOC to the right of the main content column so it
       * never overlaps the left side-bar or the main column. This computes
       * the main-content bounding rect and places the TOC with a small gap.
       */
      function adjustTocPosition(){
        try {
          var toc = document.getElementById('tocbot-toc');
          var mainContent = document.querySelector('.main-content');
          if (!toc || !mainContent) return;

          /* Hide on narrow viewports (matches the CSS rule in custom.css) */
          if (window.innerWidth < 1000) {
            toc.style.display = 'none';
            return;
          } else {
            toc.style.display = '';
          }

          var rect = mainContent.getBoundingClientRect();
          /* place TOC 16px to the right of the main content */
          /* Anchor the TOC to the viewport right side to avoid complex left
           * calculations that can accidentally place it over content. Use
           * a small right offset so it stays visible and doesn't affect layout. */
          toc.style.position = 'fixed';
          toc.style.right = '2rem';
          toc.style.left = 'auto';
          toc.style.top = (Math.max(80, rect.top + 10)) + 'px';
          toc.style.visibility = toc.style.visibility || 'visible';
          toc.style.zIndex = 1000;
        } catch (e) {
          /* fail silently */
        }
      }

      /* adjust on load and resize */
      window.addEventListener('load', adjustTocPosition, false);
      window.addEventListener('resize', adjustTocPosition, false);
      /* also run shortly after init in case layout shifts */
      setTimeout(adjustTocPosition, 250);

  /* Ensure tocbot recalculates/refreshes after the page has rendered and
   * after our sanitization of the DOM. This helps the TOC populate when
   * the content is generated server-side and when layout shifts occur. */
  setTimeout(function(){ try { if (window.tocbot && typeof tocbot.refresh === 'function') tocbot.refresh(); } catch(e){} }, 600);

      /* If tocbot didn't populate (empty nav), build a simple fallback TOC
       * from the headings in the page so the user always has a TOC. */
      function slugify(text){
        return text.toString().toLowerCase().trim()
          .replace(/\s+/g, '-')           // Replace spaces with -
          .replace(/[^a-z0-9\-]/g, '')    // Remove invalid chars
          .replace(/\-\-+/g, '-');       // Collapse dashes
      }

      function buildFallbackToc(){
        try {
          var toc = document.getElementById('tocbot-toc');
          var content = document.querySelector('.main-content');
          if (!toc || !content) return;
          // if tocbot already populated links, don't overwrite
          if (toc.querySelectorAll('a').length > 0) return;

          var headings = content.querySelectorAll('h1, h2, h3, h4');
          if (!headings || headings.length === 0) return;

          var ol = document.createElement('ol');
          ol.className = 'fallback-toc-list';
          headings.forEach(function(h){
            var text = (h.textContent || '').trim();
            if (!text) return;
            var id = h.id || slugify(text);
            if (!h.id) h.id = id;
            var li = document.createElement('li');
            var a = document.createElement('a');
            a.href = '#'+id;
            a.textContent = text;
            li.appendChild(a);
            ol.appendChild(li);
          });
          // clear and append
          toc.innerHTML = '';
          var title = document.createElement('div');
          title.className = 'toc-title';
          title.textContent = 'Contents';
          toc.appendChild(title);
          toc.appendChild(ol);
        } catch(e){ /* silent */ }
      }

      setTimeout(buildFallbackToc, 800);

      /* Remove numeric prefixes from TOC entries (e.g. "1. a. Title") so
       * the TOC doesn't duplicate numbering that is already present in
       * heading text. This strips repeated leading groups like "1. a. " */
      function stripTocNumbers(){
        try {
          var toc = document.getElementById('tocbot-toc');
          if (!toc) return;
          var links = toc.querySelectorAll('a');
          links.forEach(function(a){
            var txt = (a.textContent || '').trim();
            /* Remove multiple leading numeric or alpha groups like "1. a. " */
            var cleaned = txt.replace(/^\s*(?:(?:\d+|[a-zA-Z])\.\s*)+/, '');
            /* If there are inner span elements (toc numbering), replace innerHTML
             * with the cleaned text to remove them entirely. */
            if (cleaned !== txt) a.innerHTML = cleaned;
          });
        } catch (e) { /* silent */ }
      }

      window.addEventListener('load', stripTocNumbers, false);
      window.addEventListener('resize', function(){ setTimeout(stripTocNumbers, 100); }, false);
      setTimeout(stripTocNumbers, 350);

      /* Additional sanitization: remove any numbering spans/elements that
       * tocbot or the theme may inject as separate nodes. This walks each
       * TOC link and strips child nodes that look like counters (purely
       * numeric or classes that include "number"), keeping only the text. */
      function sanitizeToc(){
        try {
          var toc = document.getElementById('tocbot-toc');
          if (!toc) return;
          var links = toc.querySelectorAll('a');
          links.forEach(function(a){
            // Remove child elements that are likely numbering spans
            var children = Array.from(a.childNodes);
            children.forEach(function(node){
              if (node.nodeType === Node.ELEMENT_NODE){
                var cls = (node.className || '').toString().toLowerCase();
                var txt = (node.textContent || '').trim();
                if (cls.indexOf('number') !== -1 || /^\d+[\.|\)]?$/.test(txt)){
                  node.remove();
                }
              } else if (node.nodeType === Node.TEXT_NODE){
                // Trim leading numeric tokens from text nodes
                node.textContent = node.textContent.replace(/^\s*(?:(?:\d+|[a-zA-Z])\.\s*)+/, '');
              }
            });
            // Finally, collapse multiple spaces
            a.textContent = (a.textContent || '').replace(/\s{2,}/g, ' ').trim();
          });
        } catch (e){ /* silent */ }
      }

      window.addEventListener('load', sanitizeToc, false);
      window.addEventListener('resize', function(){ setTimeout(sanitizeToc, 200); }, false);
      setTimeout(sanitizeToc, 450);

      /* Strip numbering from any in-page TOC generated by the site (the
       * `{:toc}` liquid tag). We look for common container classes and for
       * <details> blocks with a "Table of contents" summary. */
      function stripInPageToc(){
        try {
          var selectors = [
            '.main-content .toc',
            '.main-content .table-of-contents',
            '.main-content nav.toc',
            '.main-content details'
          ];
          selectors.forEach(function(sel){
            var nodes = document.querySelectorAll(sel);
            nodes.forEach(function(node){
              // If it's a details block, check summary text
              if (node.tagName && node.tagName.toLowerCase() === 'details'){
                var s = node.querySelector('summary');
                if (!s || !/table of contents/i.test(s.textContent || '')) return;
              }
              var links = node.querySelectorAll('a');
              links.forEach(function(a){
                a.textContent = (a.textContent || '').replace(/^\s*(?:(?:\d+|[a-zA-Z])\.\s*)+/, '').trim();
              });
            });
          });
        } catch (e) { /* silent */ }
      }

      window.addEventListener('load', stripInPageToc, false);
      window.addEventListener('resize', function(){ setTimeout(stripInPageToc, 200); }, false);
      setTimeout(stripInPageToc, 400);

      /*
       * Ensure the main column margin-left matches the side-bar width so the
       * main content never overlaps the fixed sidebar. This mirrors the
       * theme behavior but defends against cases where styles are different
       * or the DOM is modified dynamically.
       */
      function adjustMainMargin(){
        try {
          var sidebar = document.querySelector('.side-bar');
          var main = document.querySelector('.main');
          if (!sidebar || !main) return;

          /* Only apply on wide viewports where sidebar is fixed */
          if (window.innerWidth < 800) {
            main.style.marginLeft = '';
            return;
          }

          var sidebarRect = sidebar.getBoundingClientRect();
          var sidebarWidth = Math.ceil(sidebarRect.width);
          /* add small gap of 16px to separate columns */
          var target = sidebarWidth + 16;
          main.style.marginLeft = target + 'px';
        } catch (e) {
          /* silent */
        }
      }

      window.addEventListener('load', adjustMainMargin, false);
      window.addEventListener('resize', adjustMainMargin, false);
      setTimeout(adjustMainMargin, 150);
    </script>
  {% endif %}